<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de aulas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .status-confirmada { background: #10b981; }
        .status-reagendada { background: #f59e0b; }
        .status-dada { background: #3b82f6; }
        .status-cancelada { background: #ef4444; }
        
        /* Cover page animations */
        @keyframes bounce-slow {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(10deg); }
        }
        
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-bounce-slow { animation: bounce-slow 3s ease-in-out infinite; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-fade-in { animation: fade-in 1s ease-out forwards; opacity: 0; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg" id="main-header" style="display: none;">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <h1 class="text-2xl font-bold">Gest√£o de aulas</h1>
                </div>
                <nav class="hidden md:flex space-x-6">
                    <button onclick="showSection('agenda')" class="nav-btn hover:text-purple-200 transition-colors">
                        <i class="fas fa-calendar-alt mr-2"></i>Agenda
                    </button>
                    <button onclick="showSection('students')" class="nav-btn hover:text-purple-200 transition-colors">
                        <i class="fas fa-users mr-2"></i>Alunos
                    </button>
                    <button onclick="showSection('reports')" class="nav-btn hover:text-purple-200 transition-colors">
                        <i class="fas fa-chart-bar mr-2"></i>Relat√≥rios
                    </button>
                    <button onclick="showSection('evolution')" class="nav-btn hover:text-purple-200 transition-colors">
                        <i class="fas fa-book mr-2"></i>Evolu√ß√£o
                    </button>
                    <button onclick="showSection('backup')" class="nav-btn hover:text-purple-200 transition-colors">
                        <i class="fas fa-download mr-2"></i>Backup
                    </button>
                </nav>
                <div class="flex items-center space-x-3">
                    <button onclick="closeApp()" class="text-white hover:text-red-200 transition-colors" title="Fechar App">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                    <button class="md:hidden text-white" onclick="toggleMobileMenu()">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Menu -->
    <div id="mobileMenu" class="hidden md:hidden bg-purple-700 text-white">
        <div class="px-6 py-4 space-y-3">
            <button onclick="showSection('agenda')" class="block w-full text-left py-2 hover:bg-purple-600 rounded">
                <i class="fas fa-calendar-alt mr-2"></i>Agenda
            </button>
            <button onclick="showSection('students')" class="block w-full text-left py-2 hover:bg-purple-600 rounded">
                <i class="fas fa-users mr-2"></i>Alunos
            </button>
            <button onclick="showSection('reports')" class="block w-full text-left py-2 hover:bg-purple-600 rounded">
                <i class="fas fa-chart-bar mr-2"></i>Relat√≥rios
            </button>
            <button onclick="showSection('evolution')" class="block w-full text-left py-2 hover:bg-purple-600 rounded">
                <i class="fas fa-book mr-2"></i>Evolu√ß√£o
            </button>
            <button onclick="showSection('backup')" class="block w-full text-left py-2 hover:bg-purple-600 rounded">
                <i class="fas fa-download mr-2"></i>Backup
            </button>
        </div>
    </div>

    <!-- Login Page - REMOVIDA (sistema permanente) -->
    <div id="login-page" class="hidden">
        <!-- Tela de login removida - sistema agora √© permanente -->
    </div>

    <!-- Cover Page -->
    <div id="cover-page" class="min-h-screen flex items-center justify-center relative overflow-hidden" style="display: none;">
        <div class="absolute inset-0 gradient-bg"></div>
        <div class="absolute inset-0 opacity-10">
            <div class="absolute top-20 left-20 w-32 h-32 bg-white rounded-full animate-pulse"></div>
            <div class="absolute bottom-32 right-32 w-24 h-24 bg-white rounded-full animate-pulse" style="animation-delay: 1s;"></div>
            <div class="absolute top-1/2 left-10 w-16 h-16 bg-white rounded-full animate-pulse" style="animation-delay: 2s;"></div>
        </div>
        
        <div class="relative z-10 text-center text-white px-6">
            <div class="mb-8 flex justify-center">
                <div class="relative">
                    <!-- Dancing Figure SVG -->
                    <svg width="200" height="300" viewBox="0 0 200 300" class="animate-bounce-slow">
                        <!-- Body -->
                        <ellipse cx="100" cy="50" rx="25" ry="35" fill="white" opacity="0.9"/>
                        
                        <!-- Head -->
                        <circle cx="100" cy="25" r="20" fill="white" opacity="0.9"/>
                        
                        <!-- Left Arm (raised) -->
                        <ellipse cx="70" cy="60" rx="8" ry="30" fill="white" opacity="0.9" transform="rotate(-30 70 60)"/>
                        <ellipse cx="55" cy="45" rx="6" ry="20" fill="white" opacity="0.9" transform="rotate(-45 55 45)"/>
                        
                        <!-- Right Arm (extended) -->
                        <ellipse cx="130" cy="65" rx="8" ry="30" fill="white" opacity="0.9" transform="rotate(45 130 65)"/>
                        <ellipse cx="150" cy="75" rx="6" ry="20" fill="white" opacity="0.9" transform="rotate(60 150 75)"/>
                        
                        <!-- Left Leg -->
                        <ellipse cx="85" cy="120" rx="10" ry="40" fill="white" opacity="0.9" transform="rotate(-15 85 120)"/>
                        <ellipse cx="80" cy="170" rx="8" ry="35" fill="white" opacity="0.9" transform="rotate(-25 80 170)"/>
                        
                        <!-- Right Leg -->
                        <ellipse cx="115" cy="125" rx="10" ry="40" fill="white" opacity="0.9" transform="rotate(20 115 125)"/>
                        <ellipse cx="125" cy="175" rx="8" ry="35" fill="white" opacity="0.9" transform="rotate(30 125 175)"/>
                        
                        <!-- Dress/Skirt flowing -->
                        <path d="M 75 85 Q 100 95 125 85 Q 130 110 120 130 Q 100 125 80 130 Q 70 110 75 85" fill="white" opacity="0.8"/>
                    </svg>
                    
                    <!-- Floating musical notes -->
                    <div class="absolute -top-5 -right-5 text-2xl animate-float">‚ô™</div>
                    <div class="absolute top-10 -left-8 text-xl animate-float" style="animation-delay: 0.5s;">‚ô´</div>
                    <div class="absolute -bottom-5 right-5 text-lg animate-float" style="animation-delay: 1s;">‚ô™</div>
                </div>
            </div>
            
            <h1 class="text-5xl md:text-6xl font-bold mb-4 animate-fade-in">
                Gest√£o de Aulas
            </h1>
            <p class="text-xl md:text-2xl mb-8 opacity-90 animate-fade-in" style="animation-delay: 0.5s;">
                Sistema completo para professores de dan√ßa
            </p>
            
            <div class="space-y-4 animate-fade-in" style="animation-delay: 1s;">
                <div class="flex flex-wrap justify-center gap-4 text-lg mb-8">
                    <span class="flex items-center bg-white bg-opacity-20 px-4 py-2 rounded-full">
                        <i class="fas fa-calendar-alt mr-2"></i>
                        Agenda
                    </span>
                    <span class="flex items-center bg-white bg-opacity-20 px-4 py-2 rounded-full">
                        <i class="fas fa-users mr-2"></i>
                        Alunos
                    </span>
                    <span class="flex items-center bg-white bg-opacity-20 px-4 py-2 rounded-full">
                        <i class="fas fa-chart-bar mr-2"></i>
                        Relat√≥rios
                    </span>
                    <span class="flex items-center bg-white bg-opacity-20 px-4 py-2 rounded-full">
                        <i class="fas fa-book mr-2"></i>
                        Evolu√ß√£o
                    </span>
                    <span class="flex items-center bg-white bg-opacity-20 px-4 py-2 rounded-full">
                        <i class="fas fa-download mr-2"></i>
                        Backup
                    </span>
                </div>
                
                <button onclick="enterSystem()" class="bg-white text-purple-600 px-8 py-4 rounded-full text-xl font-semibold hover:bg-opacity-90 transition-all duration-300 transform hover:scale-105 shadow-lg">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    Entrar no Sistema
                </button>
            </div>
        </div>
        
        <!-- Decorative elements -->
        <div class="absolute bottom-0 left-0 w-full h-32 bg-gradient-to-t from-black to-transparent opacity-20"></div>
    </div>

    <div class="container mx-auto px-6 py-8" id="main-app" style="display: none;">
        <!-- Agenda Section -->
        <div id="agenda-section" class="section">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">
                    <i class="fas fa-calendar-alt mr-3 text-purple-600"></i>Agenda de Aulas
                </h2>
                <button onclick="openLessonModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                    <i class="fas fa-plus mr-2"></i>Nova Aula
                </button>
            </div>

            <!-- Calendar View -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold text-gray-800">Calend√°rio</h3>
                    <div class="flex items-center space-x-4">
                        <button onclick="previousMonth()" class="p-2 hover:bg-gray-100 rounded-lg">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="currentMonth" class="font-medium text-lg"></span>
                        <button onclick="nextMonth()" class="p-2 hover:bg-gray-100 rounded-lg">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div id="calendar" class="grid grid-cols-7 gap-2"></div>
            </div>

            <!-- Lessons List -->
            <div class="bg-white rounded-xl card-shadow p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Pr√≥ximas Aulas</h3>
                <div id="lessonsList" class="space-y-3"></div>
            </div>
        </div>

        <!-- Students Section -->
        <div id="students-section" class="section hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">
                    <i class="fas fa-users mr-3 text-purple-600"></i>Alunos
                </h2>
                <div class="flex space-x-3">
                    <button onclick="refreshStudentsData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 rounded-lg font-medium transition-colors" title="Atualizar dados dos alunos">
                        <i class="fas fa-sync-alt mr-2"></i>Atualizar
                    </button>
                    <button onclick="openStudentModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>Novo Aluno
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl card-shadow p-6">
                <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="text" id="studentSearch" placeholder="Buscar alunos..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                           oninput="filterStudents()">
                    <select id="studentStatusFilter" onchange="filterStudents()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="all">Todos os alunos</option>
                        <option value="active">Apenas ativos</option>
                        <option value="inactive">Apenas inativos</option>
                    </select>
                </div>
                <div id="studentsList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports-section" class="section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">
                <i class="fas fa-chart-bar mr-3 text-purple-600"></i>Relat√≥rios
            </h2>

            <!-- Year Filter -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <div class="flex items-center space-x-4">
                    <label class="font-medium text-gray-700">Ano:</label>
                    <select id="reportYear" onchange="updateReports()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                        <option value="2028">2028</option>
                        <option value="2029">2029</option>
                        <option value="2030">2030</option>
                        <option value="2031">2031</option>
                        <option value="2032">2032</option>
                        <option value="2033">2033</option>
                        <option value="2034">2034</option>
                        <option value="2035">2035</option>
                        <option value="2036">2036</option>
                        <option value="2037">2037</option>
                        <option value="2038">2038</option>
                        <option value="2039">2039</option>
                        <option value="2040">2040</option>
                    </select>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-6">
                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-lg">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Aulas Dadas</p>
                            <p id="lessonsDone" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-red-100 rounded-lg">
                            <i class="fas fa-times-circle text-red-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Aulas Canceladas</p>
                            <p id="lessonsCanceled" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <i class="fas fa-users text-blue-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Alunos Ativos</p>
                            <p id="activeStudents" class="text-2xl font-bold text-gray-800">0</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="p-3 bg-purple-100 rounded-lg">
                                <i class="fas fa-dollar-sign text-purple-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">Receita Anual</p>
                                <p id="annualRevenue" class="text-2xl font-bold text-gray-800">R$ 0</p>
                                <p id="annualRevenueHidden" class="text-2xl font-bold text-gray-800 hidden">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</p>
                            </div>
                        </div>
                        <button onclick="toggleRevenueVisibility('annual')" class="text-gray-400 hover:text-gray-600 transition-colors" title="Mostrar/Ocultar receita">
                            <i id="annualRevenueEye" class="fas fa-eye text-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="p-3 bg-orange-100 rounded-lg">
                                <i class="fas fa-calendar-month text-orange-600 text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm text-gray-600">Receita Mensal</p>
                                <p id="monthlyRevenue" class="text-2xl font-bold text-gray-800">R$ 0</p>
                                <p id="monthlyRevenueHidden" class="text-2xl font-bold text-gray-800 hidden">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</p>
                            </div>
                        </div>
                        <button onclick="toggleRevenueVisibility('monthly')" class="text-gray-400 hover:text-gray-600 transition-colors" title="Mostrar/Ocultar receita">
                            <i id="monthlyRevenueEye" class="fas fa-eye text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Monthly Lessons Chart -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Aulas por M√™s</h3>
                    <canvas id="monthlyChart" width="400" height="300"></canvas>
                </div>
                
                <!-- Revenue Chart -->
                <div class="bg-white rounded-xl card-shadow p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Receita Mensal</h3>
                        <button onclick="toggleRevenueVisibility('chart')" class="text-gray-400 hover:text-gray-600 transition-colors" title="Mostrar/Ocultar receita">
                            <i id="chartRevenueEye" class="fas fa-eye text-lg"></i>
                        </button>
                    </div>
                    <canvas id="revenueChart" width="400" height="300"></canvas>
                    <div id="revenueChartHidden" class="hidden flex items-center justify-center h-64 text-gray-400">
                        <div class="text-center">
                            <i class="fas fa-eye-slash text-4xl mb-2"></i>
                            <p>Receita oculta</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Status Distribution Chart -->
            <div class="bg-white rounded-xl card-shadow p-6 mt-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Distribui√ß√£o de Status das Aulas</h3>
                <div class="flex justify-center">
                    <canvas id="statusChart" width="400" height="400"></canvas>
                </div>
            </div>
        </div>

        <!-- Evolution Section -->
        <div id="evolution-section" class="section hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">
                    <i class="fas fa-book mr-3 text-purple-600"></i>Evolu√ß√£o dos Alunos
                </h2>
                <div class="flex space-x-3">
                    <button onclick="openEvolutionModal()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>Nova Anota√ß√£o
                    </button>
                </div>
            </div>

            <!-- Student Selection -->
            <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Selecionar Aluno</label>
                        <select id="evolutionStudentFilter" onchange="filterEvolutionByStudent()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="">Todos os alunos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Buscar nas anota√ß√µes</label>
                        <input type="text" id="evolutionSearch" placeholder="Buscar por conte√∫do..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                               oninput="filterEvolutionByStudent()">
                    </div>
                </div>
            </div>

            <!-- Evolution Timeline -->
            <div class="bg-white rounded-xl card-shadow p-6">
                <div id="evolutionTimeline" class="space-y-6">
                    <!-- Evolution entries will be populated here -->
                </div>
                <div id="noEvolutionData" class="text-center py-12 text-gray-500 hidden">
                    <i class="fas fa-book-open text-4xl mb-4 text-gray-300"></i>
                    <h3 class="text-lg font-medium mb-2">Nenhuma anota√ß√£o encontrada</h3>
                    <p class="text-sm">Comece a documentar a evolu√ß√£o dos seus alunos!</p>
                </div>
            </div>
        </div>

        <!-- Backup Section -->
        <div id="backup-section" class="section hidden">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">
                <i class="fas fa-download mr-3 text-purple-600"></i>Backup & Restaura√ß√£o
            </h2>

            <!-- Sync Info -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-xl p-6 mb-6">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-exclamation-triangle text-yellow-600 mt-1"></i>
                    <div>
                        <h3 class="font-semibold text-yellow-800 mb-2">Sincroniza√ß√£o entre Dispositivos</h3>
                        <p class="text-yellow-700 text-sm mb-3">
                            Sua conta e dados ficam salvos apenas no dispositivo atual. Para acessar em outros dispositivos:
                        </p>
                        <ol class="text-yellow-700 text-sm space-y-1 ml-4">
                            <li>1. Fa√ßa backup por email no dispositivo atual</li>
                            <li>2. No novo dispositivo, configure uma nova conta</li>
                            <li>3. Use "Restaurar Backup" com o arquivo do email</li>
                        </ol>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Backup por Email</h3>
                    <p class="text-gray-600 mb-4">Envie backup dos seus dados para seu email cadastrado.</p>
                    <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-center">
                            <i class="fas fa-envelope text-blue-500 mr-2"></i>
                            <span class="text-sm text-blue-700" id="userEmailDisplay">Email n√£o configurado</span>
                        </div>
                    </div>
                    <button onclick="sendBackupEmail()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-medium transition-colors w-full">
                        <i class="fas fa-paper-plane mr-2"></i>Enviar Backup por Email
                    </button>
                </div>

                <div class="bg-white rounded-xl card-shadow p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Backup Local</h3>
                    <p class="text-gray-600 mb-4">Baixe backup dos seus dados ou restaure de um arquivo.</p>
                    <div class="space-y-3">
                        <button onclick="exportData()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition-colors w-full">
                            <i class="fas fa-download mr-2"></i>Baixar Backup
                        </button>
                        <input type="file" id="importFile" accept=".json" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                        <button onclick="importData()" class="bg-orange-600 hover:bg-orange-700 text-white px-6 py-3 rounded-lg font-medium transition-colors w-full">
                            <i class="fas fa-upload mr-2"></i>Restaurar Backup
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lesson Modal -->
    <div id="lessonModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Nova Aula</h3>
                <button onclick="closeLessonModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="lessonForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data e Hora</label>
                    <input type="datetime-local" id="lessonDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Aluno</label>
                    <select id="lessonStudent" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="">Selecione um aluno</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Estilo</label>
                        <input type="text" id="lessonStyle" placeholder="Digite o estilo de dan√ßa" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" list="styleOptions">
                        <datalist id="styleOptions">
                            <option value="Forr√≥ Universit√°rio">
                            <option value="Forr√≥ Roots">
                            <option value="Gafieira">
                            <option value="Samba no P√©">
                            <option value="Salsa">
                            <option value="Tango">
                            <option value="Bachata">
                            <option value="Dan√ßa de Sal√£o">
                            <option value="Zouk">
                            <option value="Kizomba">
                            <option value="Sertanejo">
                            <option value="Bolero">
                            <option value="Merengue">
                            <option value="Cha Cha Cha">
                            <option value="Rumba">
                            <option value="Jive">
                            <option value="Quickstep">
                            <option value="Foxtrot">
                            <option value="Valsa">
                            <option value="Swing">
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">N√≠vel</label>
                        <input type="text" id="lessonLevel" placeholder="Digite o n√≠vel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" list="levelOptions">
                        <datalist id="levelOptions">
                            <option value="Iniciante">
                            <option value="Intermedi√°rio">
                            <option value="Avan√ßado">
                            <option value="B√°sico">
                            <option value="Fundamental">
                            <option value="Aperfei√ßoamento">
                            <option value="Profissional">
                            <option value="Master">
                        </datalist>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                        <input type="text" id="lessonType" placeholder="Digite o tipo de aula" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" list="typeOptions">
                        <datalist id="typeOptions">
                            <option value="Particular">
                            <option value="Casal">
                            <option value="Turma">
                            <option value="Grupo">
                            <option value="Workshop">
                            <option value="Intensivo">
                            <option value="Masterclass">
                            <option value="Ensaio">
                            <option value="Pr√°tica">
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Modelo</label>
                        <input type="text" id="lessonModel" placeholder="Digite o modelo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" list="modelOptions">
                        <datalist id="modelOptions">
                            <option value="Avulsa">
                            <option value="Pacote">
                            <option value="Mensal">
                            <option value="Trimestral">
                            <option value="Semestral">
                            <option value="Anual">
                            <option value="Experimental">
                            <option value="Cortesia">
                        </datalist>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dura√ß√£o (min)</label>
                        <input type="number" id="lessonDuration" value="60" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pre√ßo (R$)</label>
                        <input type="number" id="lessonPrice" value="60" step="0.01" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Local</label>
                    <input type="text" id="lessonPlace" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="lessonStatus" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="0">Confirmada</option>
                        <option value="1">Reagendada</option>
                        <option value="2">Dada</option>
                        <option value="3">Cancelada</option>
                        <option value="4">Aula Marcada</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes</label>
                    <textarea id="lessonNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                        Salvar
                    </button>
                    <button type="button" onclick="clearLessonForm()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Limpar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal removido - sistema sem login -->

    <!-- Evolution Modal -->
    <div id="evolutionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-2xl mx-4 max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Anota√ß√£o de Evolu√ß√£o</h3>
                <button onclick="closeEvolutionModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="evolutionForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data da Aula *</label>
                        <input type="date" id="evolutionDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Aluno *</label>
                        <select id="evolutionStudent" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="">Selecione um aluno</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Estilo Trabalhado</label>
                        <input type="text" id="evolutionStyle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" list="styleOptions">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">N√≠vel</label>
                        <input type="text" id="evolutionLevel" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" list="levelOptions">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Dura√ß√£o (min)</label>
                        <input type="number" id="evolutionDuration" value="60" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Conte√∫do Trabalhado *</label>
                    <textarea id="evolutionContent" required rows="4" 
                              placeholder="Ex: Trabalhamos o passo b√°sico do forr√≥, movimentos de giro √† direita e √† esquerda..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Descreva o que foi ensinado na aula</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Evolu√ß√£o do Aluno</label>
                    <textarea id="evolutionProgress" rows="3" 
                              placeholder="Ex: Aluno demonstrou boa coordena√ß√£o nos passos b√°sicos, ainda precisa trabalhar o ritmo..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
                    <p class="text-xs text-gray-500 mt-1">Como o aluno se desenvolveu nesta aula?</p>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Dificuldades Encontradas</label>
                    <textarea id="evolutionDifficulties" rows="2" 
                              placeholder="Ex: Dificuldade em manter o tempo da m√∫sica, coordena√ß√£o entre bra√ßos e pernas..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pr√≥ximos Passos</label>
                    <textarea id="evolutionNextSteps" rows="2" 
                              placeholder="Ex: Na pr√≥xima aula trabalhar varia√ß√µes do passo b√°sico, introduzir novos movimentos..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
                    <p class="text-xs text-gray-500 mt-1">O que focar nas pr√≥ximas aulas?</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Avalia√ß√£o Geral</label>
                        <select id="evolutionRating" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="">Selecione uma avalia√ß√£o</option>
                            <option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê Excelente</option>
                            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Muito Bom</option>
                            <option value="3">‚≠ê‚≠ê‚≠ê Bom</option>
                            <option value="2">‚≠ê‚≠ê Regular</option>
                            <option value="1">‚≠ê Precisa Melhorar</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Humor do Aluno</label>
                        <select id="evolutionMood" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                            <option value="">Como estava o aluno?</option>
                            <option value="motivated">üòä Motivado</option>
                            <option value="focused">üéØ Focado</option>
                            <option value="tired">üò¥ Cansado</option>
                            <option value="frustrated">üò§ Frustrado</option>
                            <option value="excited">ü§© Empolgado</option>
                            <option value="nervous">üò∞ Nervoso</option>
                            <option value="confident">üòé Confiante</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes Extras</label>
                    <textarea id="evolutionNotes" rows="2" 
                              placeholder="Qualquer observa√ß√£o adicional sobre a aula ou o aluno..."
                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
                </div>

                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                        <i class="fas fa-save mr-2"></i>Salvar Anota√ß√£o
                    </button>
                    <button type="button" onclick="clearEvolutionForm()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Limpar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Student Modal -->
    <div id="studentModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Novo Aluno</h3>
                <button onclick="closeStudentModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="studentForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome *</label>
                    <input type="text" id="studentName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Telefone</label>
                    <input type="tel" id="studentPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="studentEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="studentActive" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                        <option value="true">Ativo</option>
                        <option value="false">Inativo</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">In√≠cio do Pacote</label>
                        <input type="date" id="studentPackageStart" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fim do Pacote</label>
                        <input type="date" id="studentPackageEnd" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Total de Aulas no Pacote</label>
                        <input type="number" id="studentTotalLessons" min="0" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="Ex: 8, 12, 16...">
                        <p class="text-xs text-gray-500 mt-1">Deixe vazio se n√£o usar pacotes</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Aulas Feitas</label>
                        <input type="number" id="studentCompletedLessons" min="0" readonly class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-600">
                        <p class="text-xs text-gray-500 mt-1">Calculado automaticamente</p>
                    </div>
                </div>
                
                <!-- Package Status Info -->
                <div id="packageStatusInfo" class="hidden p-3 rounded-lg border">
                    <div class="flex items-center space-x-2 mb-2">
                        <i class="fas fa-info-circle text-blue-500"></i>
                        <span class="font-medium text-gray-700">Status do Pacote</span>
                    </div>
                    <div id="packageStatusText" class="text-sm text-gray-600"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes</label>
                    <textarea id="studentNotes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"></textarea>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-lg font-medium transition-colors">
                        Salvar
                    </button>
                    <button type="button" onclick="clearStudentForm()" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        Limpar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Data Storage
        let students = [];
        let lessons = [];
        let evolutions = [];
        let currentDate = new Date();
        let currentEditingLesson = null;
        let currentEditingStudent = null;
        let currentEditingEvolution = null;

        // Professional Alert System
        function showAlert(message, type = 'info') {
            // Remove existing alerts
            const existingAlert = document.querySelector('.custom-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `custom-alert fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-sm transform transition-all duration-300 translate-x-full`;
            
            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                warning: 'bg-yellow-500 text-white',
                info: 'bg-blue-500 text-white'
            };
            
            const icons = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info-circle'
            };
            
            alertDiv.className += ` ${colors[type]}`;
            alertDiv.innerHTML = `
                <div class="flex items-center space-x-3">
                    <i class="${icons[type]}"></i>
                    <span class="flex-1">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Animate in
            setTimeout(() => {
                alertDiv.classList.remove('translate-x-full');
            }, 100);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.classList.add('translate-x-full');
                    setTimeout(() => alertDiv.remove(), 300);
                }
            }, 5000);
        }

        // Professional Confirmation Dialog
        function showConfirm(message, onConfirm, onCancel = null) {
            const confirmDiv = document.createElement('div');
            confirmDiv.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmDiv.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-md mx-4 shadow-2xl">
                    <div class="flex items-center space-x-3 mb-4">
                        <i class="fas fa-question-circle text-blue-500 text-2xl"></i>
                        <h3 class="text-lg font-semibold text-gray-800">Confirma√ß√£o</h3>
                    </div>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <div class="flex space-x-3 justify-end">
                        <button id="cancelBtn" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                            Cancelar
                        </button>
                        <button id="confirmBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                            Confirmar
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(confirmDiv);
            
            confirmDiv.querySelector('#confirmBtn').onclick = () => {
                confirmDiv.remove();
                if (onConfirm) onConfirm();
            };
            
            confirmDiv.querySelector('#cancelBtn').onclick = () => {
                confirmDiv.remove();
                if (onCancel) onCancel();
            };
            
            // Close on backdrop click
            confirmDiv.onclick = (e) => {
                if (e.target === confirmDiv) {
                    confirmDiv.remove();
                    if (onCancel) onCancel();
                }
            };
        }

        // Status labels
        const statusLabels = ['Confirmada', 'Reagendada', 'Dada', 'Cancelada', 'Aula Marcada'];
        const statusColors = ['status-confirmada', 'status-reagendada', 'status-dada', 'status-cancelada', 'status-confirmada'];

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            loadRevenueVisibility();
            
            // SISTEMA DIRETO - SEM LOGIN
            // Sempre entrar direto no sistema
            enterSystemDirectly();
            
            updateCalendar();
            updateLessonsList();
            updateStudentsList();
            updateReports();
            populateStudentSelect();
            populateEvolutionStudentSelect();
            updateEvolutionTimeline();
            
            // Backup autom√°tico a cada 30 segundos para prote√ß√£o
            setInterval(autoBackup, 30000);
        });

        // Sistema direto - sem autentica√ß√£o
        function enterSystemDirectly() {
            // Entrar direto no sistema
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('cover-page').style.display = 'none';
            document.getElementById('main-header').style.display = 'block';
            document.getElementById('main-app').style.display = 'block';
            showSection('agenda');
        }

        function updateEmailDisplay() {
            const savedEmail = localStorage.getItem('userEmail') || 'usuario@email.com';
            const emailDisplay = document.getElementById('userEmailDisplay');
            if (emailDisplay) {
                emailDisplay.textContent = savedEmail;
            }
        }

        // Fun√ß√µes de senha removidas - sistema sem login

        // Enter system function
        function enterSystem() {
            document.getElementById('cover-page').style.display = 'none';
            document.getElementById('main-header').style.display = 'block';
            document.getElementById('main-app').style.display = 'block';
            showSection('agenda');
        }

        // Close app function
        function closeApp() {
            showConfirm('Deseja minimizar o sistema? (Voc√™ entrar√° automaticamente na pr√≥xima vez)', () => {
                // Manter autentica√ß√£o PERMANENTE
                localStorage.setItem('isAuthenticated', 'true');
                
                // Hide main app components
                document.getElementById('main-header').style.display = 'none';
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('cover-page').style.display = 'flex';
                document.getElementById('login-page').style.display = 'none';
                
                // Reset any open modals
                closeLessonModal();
                closeStudentModal();
                closePasswordSetup();
                
                // Hide mobile menu
                document.getElementById('mobileMenu').classList.add('hidden');
                
                // Reset all sections to hidden
                document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
                
                // Clear nav states
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-purple-200'));
                
                // Reset to agenda section for next entry
                document.getElementById('agenda-section').classList.remove('hidden');
                
                // Reset editing states
                currentEditingLesson = null;
                currentEditingStudent = null;
                
                showAlert('Sistema minimizado. Clique "Entrar no Sistema" para voltar instantaneamente!', 'info');
            });
        }

        // Navigation
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(section + '-section').classList.remove('hidden');
            
            // Update nav buttons - clear all first
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-purple-200'));
            
            // Find and highlight the correct nav button
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.onclick && btn.onclick.toString().includes(`'${section}'`)) {
                    btn.classList.add('text-purple-200');
                }
            });
            
            // Hide mobile menu
            document.getElementById('mobileMenu').classList.add('hidden');
        }

        function toggleMobileMenu() {
            document.getElementById('mobileMenu').classList.toggle('hidden');
        }

        // Calendar functions
        function updateCalendar() {
            const calendar = document.getElementById('calendar');
            const monthLabel = document.getElementById('currentMonth');
            
            monthLabel.textContent = currentDate.toLocaleDateString('pt-BR', { 
                month: 'long', 
                year: 'numeric' 
            });

            // Clear calendar
            calendar.innerHTML = '';

            // Add day headers
            const dayHeaders = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            dayHeaders.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'text-center font-medium text-gray-600 py-2';
                dayHeader.textContent = day;
                calendar.appendChild(dayHeader);
            });

            // Get first day of month and number of days
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            // Generate calendar days
            for (let i = 0; i < 42; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'min-h-[80px] p-2 border border-gray-200 cursor-pointer hover:bg-gray-50';
                
                if (date.getMonth() !== currentDate.getMonth()) {
                    dayElement.classList.add('text-gray-400');
                }
                
                if (date.toDateString() === new Date().toDateString()) {
                    dayElement.classList.add('bg-purple-100', 'border-purple-300');
                }

                // Add day number
                const dayNumber = document.createElement('div');
                dayNumber.className = 'font-medium text-sm mb-1';
                dayNumber.textContent = date.getDate();
                dayElement.appendChild(dayNumber);

                // Add lessons for this day
                const dayLessons = lessons.filter(lesson => {
                    const lessonDate = new Date(lesson.date);
                    return lessonDate.toDateString() === date.toDateString();
                });

                dayLessons.forEach(lesson => {
                    const student = students.find(s => s.id === lesson.studentId);
                    const lessonElement = document.createElement('div');
                    lessonElement.className = `text-xs text-white px-1 py-1 rounded mt-1 ${statusColors[lesson.status]} cursor-pointer`;
                    lessonElement.title = `${student ? student.name : 'Sem aluno'} - ${lesson.style}`;
                    
                    if (student) {
                        lessonElement.innerHTML = `
                            <div class="font-semibold text-xs leading-tight">${student.name.substring(0, 12)}</div>
                            <div class="text-xs opacity-90 leading-tight">${lesson.style.substring(0, 10)}</div>
                        `;
                    } else {
                        lessonElement.innerHTML = `
                            <div class="font-semibold text-xs leading-tight">Sem aluno</div>
                            <div class="text-xs opacity-90 leading-tight">${lesson.style.substring(0, 10)}</div>
                        `;
                    }
                    
                    dayElement.appendChild(lessonElement);
                });

                dayElement.onclick = () => {
                    const dateTime = new Date(date);
                    dateTime.setHours(10, 0, 0, 0);
                    document.getElementById('lessonDate').value = dateTime.toISOString().slice(0, 16);
                    openLessonModal();
                };

                calendar.appendChild(dayElement);
            }
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateCalendar();
        }

        // Lesson functions
        function updateLessonsList() {
            const lessonsList = document.getElementById('lessonsList');
            const now = new Date();
            now.setHours(0, 0, 0, 0); // Set to start of today to include today's lessons
            
            const upcomingLessons = lessons
                .filter(lesson => {
                    const lessonDate = new Date(lesson.date);
                    lessonDate.setHours(0, 0, 0, 0);
                    return lessonDate >= now;
                })
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(0, 10);

            if (upcomingLessons.length === 0) {
                lessonsList.innerHTML = '<p class="text-gray-500 text-center py-8">Nenhuma aula agendada</p>';
                return;
            }

            lessonsList.innerHTML = upcomingLessons.map(lesson => {
                const student = students.find(s => s.id === lesson.studentId);
                const date = new Date(lesson.date);
                
                return `
                    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <span class="px-2 py-1 text-xs text-white rounded ${statusColors[lesson.status]}">
                                    ${statusLabels[lesson.status]}
                                </span>
                                <span class="font-bold text-lg text-gray-800">
                                    ${student ? student.name : 'Sem aluno'}
                                </span>
                                <span class="px-2 py-1 text-xs bg-gray-200 text-gray-700 rounded">
                                    ${lesson.model || 'Avulsa'}
                                </span>
                            </div>
                            <div class="text-sm text-gray-600 mb-1">
                                <span class="font-medium text-purple-600">${lesson.style} - ${lesson.level}</span>
                            </div>
                            <div class="text-sm text-gray-600 mt-1">
                                <i class="fas fa-calendar mr-1"></i>
                                ${date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' })} √†s ${date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                                <span class="ml-4">
                                    <i class="fas fa-dollar-sign mr-1"></i>
                                    R$ ${lesson.price.toFixed(2)}
                                </span>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="editLesson('${lesson.id}')" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteLesson('${lesson.id}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openLessonModal(lessonId = null) {
            currentEditingLesson = lessonId;
            const modal = document.getElementById('lessonModal');
            const form = document.getElementById('lessonForm');
            
            if (lessonId) {
                const lesson = lessons.find(l => l.id === lessonId);
                if (lesson) {
                    document.getElementById('lessonDate').value = new Date(lesson.date).toISOString().slice(0, 16);
                    document.getElementById('lessonStudent').value = lesson.studentId || '';
                    document.getElementById('lessonStyle').value = lesson.style;
                    document.getElementById('lessonLevel').value = lesson.level;
                    document.getElementById('lessonType').value = lesson.type;
                    document.getElementById('lessonModel').value = lesson.model || 'Avulsa';
                    document.getElementById('lessonDuration').value = lesson.durationMin;
                    document.getElementById('lessonPlace').value = lesson.place;
                    document.getElementById('lessonPrice').value = lesson.price;
                    document.getElementById('lessonStatus').value = lesson.status;
                    document.getElementById('lessonNotes').value = lesson.notes;
                }
            } else {
                form.reset();
                document.getElementById('lessonDuration').value = 60;
                document.getElementById('lessonPrice').value = 60;
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeLessonModal() {
            document.getElementById('lessonModal').classList.add('hidden');
            document.getElementById('lessonModal').classList.remove('flex');
            currentEditingLesson = null;
        }

        function clearLessonForm() {
            document.getElementById('lessonForm').reset();
            document.getElementById('lessonDuration').value = 60;
            document.getElementById('lessonPrice').value = 60;
        }

        function editLesson(lessonId) {
            openLessonModal(lessonId);
        }

        function deleteLesson(lessonId) {
            const lesson = lessons.find(l => l.id === lessonId);
            const student = students.find(s => s.id === lesson?.studentId);
            const lessonInfo = lesson ? `${lesson.style} - ${student?.name || 'Sem aluno'}` : 'esta aula';
            
            showConfirm(`Tem certeza que deseja excluir ${lessonInfo}?`, () => {
                lessons = lessons.filter(l => l.id !== lessonId);
                saveData();
                updateCalendar();
                updateLessonsList();
                updateReports();
                showAlert('Aula exclu√≠da com sucesso', 'success');
            });
        }

        // Student functions
        function updateStudentsList() {
            const studentsList = document.getElementById('studentsList');
            const searchTerm = document.getElementById('studentSearch')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('studentStatusFilter')?.value || 'all';
            
            let filteredStudents = students.filter(student => {
                const matchesSearch = student.name.toLowerCase().includes(searchTerm) ||
                    student.phone.includes(searchTerm) ||
                    student.email.toLowerCase().includes(searchTerm);
                
                const matchesStatus = statusFilter === 'all' || 
                    (statusFilter === 'active' && student.active !== false) ||
                    (statusFilter === 'inactive' && student.active === false);
                
                return matchesSearch && matchesStatus;
            });

            if (filteredStudents.length === 0) {
                studentsList.innerHTML = '<div class="col-span-full text-center py-8 text-gray-500">Nenhum aluno encontrado</div>';
                return;
            }

            studentsList.innerHTML = filteredStudents.map(student => {
                const isActive = student.active !== false;
                const completedLessons = calculateCompletedLessons(student.id);
                const totalLessons = student.totalLessons || 0;
                const remainingLessons = totalLessons > 0 ? Math.max(0, totalLessons - completedLessons) : 0;
                const packageStatus = getPackageStatus(student, completedLessons);
                
                return `
                    <div class="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors ${!isActive ? 'opacity-60' : ''}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-2">
                                <h4 class="font-medium text-gray-800">${student.name}</h4>
                                <span class="px-2 py-1 text-xs rounded ${isActive ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                    ${isActive ? 'Ativo' : 'Inativo'}
                                </span>
                                ${packageStatus.badge}
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="editStudent('${student.id}')" class="text-blue-600 hover:text-blue-800" title="Editar aluno">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${packageStatus.showNewPackageBtn ? `
                                    <button onclick="startNewPackage('${student.id}')" class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors" title="Iniciar novo pacote">
                                        <i class="fas fa-plus mr-1"></i>Novo Pacote
                                    </button>
                                ` : ''}
                                <button onclick="deleteStudent('${student.id}')" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors">
                                    Excluir
                                </button>
                            </div>
                        </div>
                        ${student.phone ? `<p class="text-sm text-gray-600"><i class="fas fa-phone mr-1"></i>${student.phone}</p>` : ''}
                        ${student.email ? `<p class="text-sm text-gray-600"><i class="fas fa-envelope mr-1"></i>${student.email}</p>` : ''}
                        ${totalLessons > 0 && student.packageStart && student.packageEnd ? `
                            <div class="text-sm text-gray-600 mt-2">
                                <i class="fas fa-graduation-cap mr-1"></i>
                                Aulas: ${completedLessons}/${totalLessons} 
                                <span class="${packageStatus.textColor}">(${remainingLessons} restantes)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div class="bg-purple-600 h-2 rounded-full transition-all duration-300" style="width: ${Math.min(100, (completedLessons / totalLessons) * 100)}%"></div>
                            </div>
                        ` : totalLessons > 0 ? `
                            <div class="text-sm text-orange-600 mt-2">
                                <i class="fas fa-exclamation-triangle mr-1"></i>
                                Pacote incompleto: defina datas de in√≠cio/fim
                            </div>
                        ` : ''}
                        ${student.packageStart && student.packageEnd ? `
                            <div class="text-sm text-gray-600 mt-2">
                                <i class="fas fa-calendar mr-1"></i>
                                Pacote: ${new Date(student.packageStart + 'T00:00:00').toLocaleDateString('pt-BR')} - ${new Date(student.packageEnd + 'T00:00:00').toLocaleDateString('pt-BR')}
                            </div>
                        ` : ''}
                        ${packageStatus.message ? `
                            <div class="text-sm mt-2 p-2 rounded ${packageStatus.messageClass}">
                                <i class="${packageStatus.messageIcon} mr-1"></i>
                                ${packageStatus.message}
                            </div>
                        ` : ''}
                        ${student.notes ? `<p class="text-sm text-gray-500 mt-2">${student.notes}</p>` : ''}
                    </div>
                `;
            }).join('');
        }

        function filterStudents() {
            updateStudentsList();
        }

        function calculateCompletedLessons(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student || !student.packageStart || !student.packageEnd) {
                return 0; // Sem pacote ativo = 0 aulas
            }
            
            const packageStart = new Date(student.packageStart + 'T00:00:00');
            const packageEnd = new Date(student.packageEnd + 'T23:59:59');
            
            return lessons.filter(lesson => {
                if (lesson.studentId !== studentId || lesson.status !== 2) {
                    return false;
                }
                
                const lessonDate = new Date(lesson.date);
                return lessonDate >= packageStart && lessonDate <= packageEnd;
            }).length;
        }

        function getPackageStatus(student, completedLessons) {
            const totalLessons = student.totalLessons || 0;
            const remainingLessons = totalLessons > 0 ? Math.max(0, totalLessons - completedLessons) : 0;
            
            // Sem pacote definido
            if (totalLessons === 0 || !student.packageStart || !student.packageEnd) {
                return {
                    badge: '',
                    textColor: 'text-gray-600',
                    showNewPackageBtn: false,
                    message: null,
                    messageClass: '',
                    messageIcon: ''
                };
            }
            
            // Verificar se o pacote j√° expirou por data
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const packageEnd = new Date(student.packageEnd + 'T00:00:00');
            const packageExpired = today > packageEnd;
            
            // Pacote finalizado (por aulas ou por data)
            if (completedLessons >= totalLessons || packageExpired) {
                const reason = packageExpired ? 'por data' : 'por aulas conclu√≠das';
                return {
                    badge: '<span class="px-2 py-1 text-xs rounded bg-red-100 text-red-700">Pacote Finalizado</span>',
                    textColor: 'text-red-600',
                    showNewPackageBtn: true,
                    message: `Pacote finalizado ${reason}! Clique em "Novo Pacote" para continuar.`,
                    messageClass: 'bg-red-50 border border-red-200 text-red-700',
                    messageIcon: 'fas fa-exclamation-triangle'
                };
            }
            
            // Pacote quase no fim (1-2 aulas restantes OU pr√≥ximo do fim por data)
            const daysUntilEnd = Math.ceil((packageEnd - today) / (1000 * 60 * 60 * 24));
            const nearEndByLessons = remainingLessons <= 2 && remainingLessons > 0;
            const nearEndByDate = daysUntilEnd <= 7 && daysUntilEnd > 0;
            
            if (nearEndByLessons || nearEndByDate) {
                let warningMessage = '';
                if (nearEndByLessons) {
                    warningMessage = `Restam apenas ${remainingLessons} aula${remainingLessons > 1 ? 's' : ''} no pacote.`;
                }
                if (nearEndByDate) {
                    warningMessage += (warningMessage ? ' ' : '') + `Pacote expira em ${daysUntilEnd} dia${daysUntilEnd > 1 ? 's' : ''}.`;
                }
                
                return {
                    badge: '<span class="px-2 py-1 text-xs rounded bg-yellow-100 text-yellow-700">Finalizando</span>',
                    textColor: 'text-yellow-600',
                    showNewPackageBtn: false,
                    message: `Aten√ß√£o: ${warningMessage}`,
                    messageClass: 'bg-yellow-50 border border-yellow-200 text-yellow-700',
                    messageIcon: 'fas fa-exclamation-circle'
                };
            }
            
            // Pacote em andamento
            return {
                badge: '<span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700">Em Andamento</span>',
                textColor: 'text-blue-600',
                showNewPackageBtn: false,
                message: null,
                messageClass: '',
                messageIcon: ''
            };
        }

        function startNewPackage(studentId) {
            const student = students.find(s => s.id === studentId);
            if (!student) return;
            
            showConfirm(`Iniciar novo pacote de aulas para ${student.name}?\n\nIsso criar√° um pacote completamente novo, sem considerar aulas anteriores.`, () => {
                // Open student modal with new package setup
                openStudentModal(studentId);
                
                // Clear package dates and reset lesson count for new package
                setTimeout(() => {
                    // Limpar completamente os dados do pacote anterior
                    document.getElementById('studentPackageStart').value = '';
                    document.getElementById('studentPackageEnd').value = '';
                    document.getElementById('studentTotalLessons').value = '';
                    document.getElementById('studentCompletedLessons').value = '0';
                    
                    // Esconder informa√ß√µes do pacote anterior
                    document.getElementById('packageStatusInfo').classList.add('hidden');
                    
                    // Focar no campo de total de aulas
                    document.getElementById('studentTotalLessons').focus();
                    
                    showAlert('Configure o novo pacote: defina as datas de in√≠cio/fim e quantidade de aulas', 'info');
                }, 100);
            });
        }

        function refreshStudentsData() {
            // Add loading animation to the refresh button
            const refreshBtn = document.querySelector('button[onclick="refreshStudentsData()"]');
            const originalContent = refreshBtn.innerHTML;
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Atualizando...';
            refreshBtn.disabled = true;
            
            // Simulate refresh delay for better UX
            setTimeout(() => {
                updateStudentsList();
                populateStudentSelect();
                
                // Restore button
                refreshBtn.innerHTML = originalContent;
                refreshBtn.disabled = false;
                
                showAlert('Dados dos alunos atualizados!', 'success');
            }, 500);
        }

        function openStudentModal(studentId = null) {
            currentEditingStudent = studentId;
            const modal = document.getElementById('studentModal');
            const form = document.getElementById('studentForm');
            
            if (studentId) {
                const student = students.find(s => s.id === studentId);
                if (student) {
                    document.getElementById('studentName').value = student.name || '';
                    document.getElementById('studentPhone').value = student.phone || '';
                    document.getElementById('studentEmail').value = student.email || '';
                    document.getElementById('studentActive').value = student.active !== false ? 'true' : 'false';
                    document.getElementById('studentPackageStart').value = student.packageStart || '';
                    document.getElementById('studentPackageEnd').value = student.packageEnd || '';
                    document.getElementById('studentTotalLessons').value = student.totalLessons || '';
                    document.getElementById('studentCompletedLessons').value = calculateCompletedLessons(studentId);
                    document.getElementById('studentNotes').value = student.notes || '';
                    
                    // Show package status info
                    updatePackageStatusInfo(student, calculateCompletedLessons(studentId));
                }
            } else {
                form.reset();
                document.getElementById('studentActive').value = 'true';
                document.getElementById('studentCompletedLessons').value = '0';
                document.getElementById('packageStatusInfo').classList.add('hidden');
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function updatePackageStatusInfo(student, completedLessons) {
            const statusInfo = document.getElementById('packageStatusInfo');
            const statusText = document.getElementById('packageStatusText');
            const totalLessons = student.totalLessons || 0;
            
            if (totalLessons > 0 && student.packageStart && student.packageEnd) {
                const packageStatus = getPackageStatus(student, completedLessons);
                const remainingLessons = Math.max(0, totalLessons - completedLessons);
                
                statusInfo.classList.remove('hidden');
                statusInfo.className = `p-3 rounded-lg border ${packageStatus.messageClass || 'bg-blue-50 border-blue-200'}`;
                
                let statusMessage = `Pacote atual: ${completedLessons}/${totalLessons} aulas conclu√≠das`;
                if (remainingLessons > 0) {
                    statusMessage += ` (${remainingLessons} restantes)`;
                }
                
                // Adicionar informa√ß√µes das datas do pacote
                const packageStart = new Date(student.packageStart + 'T00:00:00');
                const packageEnd = new Date(student.packageEnd + 'T00:00:00');
                statusMessage += `\nPer√≠odo: ${packageStart.toLocaleDateString('pt-BR')} - ${packageEnd.toLocaleDateString('pt-BR')}`;
                
                if (packageStatus.message) {
                    statusMessage += `\n${packageStatus.message}`;
                }
                
                statusText.textContent = statusMessage;
            } else {
                statusInfo.classList.add('hidden');
            }
        }

        function closeStudentModal() {
            document.getElementById('studentModal').classList.add('hidden');
            document.getElementById('studentModal').classList.remove('flex');
            currentEditingStudent = null;
        }

        function clearStudentForm() {
            document.getElementById('studentForm').reset();
            document.getElementById('studentActive').value = 'true';
            document.getElementById('studentCompletedLessons').value = '0';
        }

        // Update completed lessons and package status when total lessons field changes
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('studentTotalLessons').addEventListener('input', function() {
                if (currentEditingStudent) {
                    const completedLessons = calculateCompletedLessons(currentEditingStudent);
                    document.getElementById('studentCompletedLessons').value = completedLessons;
                    
                    const student = students.find(s => s.id === currentEditingStudent);
                    if (student) {
                        // Update student object with new total lessons for status calculation
                        const tempStudent = { ...student, totalLessons: parseInt(this.value) || 0 };
                        updatePackageStatusInfo(tempStudent, completedLessons);
                    }
                }
            });
        });



        function editStudent(studentId) {
            openStudentModal(studentId);
        }



        function deleteStudent(studentId) {
            const student = students.find(s => s.id === studentId);
            const studentLessons = lessons.filter(l => l.studentId === studentId);
            
            let message = `Tem certeza que deseja excluir o aluno ${student?.name || 'selecionado'}?`;
            if (studentLessons.length > 0) {
                message += `\n\nEste aluno possui ${studentLessons.length} aula(s) cadastrada(s). Elas tamb√©m ser√£o removidas.`;
            }
            
            showConfirm(message, () => {
                // Remove student and their lessons
                students = students.filter(s => s.id !== studentId);
                lessons = lessons.filter(l => l.studentId !== studentId);
                
                saveData();
                updateStudentsList();
                populateStudentSelect();
                updateCalendar();
                updateLessonsList();
                updateReports();
                showAlert('Aluno exclu√≠do com sucesso', 'success');
            });
        }

        function populateStudentSelect() {
            const select = document.getElementById('lessonStudent');
            select.innerHTML = '<option value="">Selecione um aluno</option>';
            
            // Show active students first, then inactive ones
            const activeStudents = students.filter(s => s.active !== false);
            const inactiveStudents = students.filter(s => s.active === false);
            
            activeStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.name;
                select.appendChild(option);
            });
            
            if (inactiveStudents.length > 0) {
                const separator = document.createElement('option');
                separator.disabled = true;
                separator.textContent = '--- Alunos Inativos ---';
                select.appendChild(separator);
                
                inactiveStudents.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.name} (Inativo)`;
                    select.appendChild(option);
                });
            }
        }

        // Reports
        function updateReports() {
            const year = parseInt(document.getElementById('reportYear').value);
            const yearLessons = lessons.filter(lesson => new Date(lesson.date).getFullYear() === year);
            
            const lessonsDone = yearLessons.filter(l => l.status === 2).length;
            const lessonsCanceled = yearLessons.filter(l => l.status === 3).length;
            const activeStudents = new Set(yearLessons.map(l => l.studentId)).size;
            const annualRevenue = yearLessons.filter(l => l.status === 2).reduce((sum, l) => sum + l.price, 0);
            
            // Calculate current month revenue
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            const monthlyLessons = lessons.filter(lesson => {
                const lessonDate = new Date(lesson.date);
                return lessonDate.getFullYear() === currentYear && 
                       lessonDate.getMonth() === currentMonth &&
                       lesson.status === 2;
            });
            const monthlyRevenue = monthlyLessons.reduce((sum, l) => sum + l.price, 0);
            
            document.getElementById('lessonsDone').textContent = lessonsDone;
            document.getElementById('lessonsCanceled').textContent = lessonsCanceled;
            document.getElementById('activeStudents').textContent = activeStudents;
            document.getElementById('annualRevenue').textContent = `R$ ${annualRevenue.toFixed(2)}`;
            document.getElementById('monthlyRevenue').textContent = `R$ ${monthlyRevenue.toFixed(2)}`;
            
            updateChart(yearLessons);
        }

        function updateChart(yearLessons) {
            try {
                updateMonthlyChart(yearLessons);
                updateRevenueChart(yearLessons);
                updateStatusChart(yearLessons);
            } catch (error) {
                console.error('Error updating charts:', error);
            }
        }

        function updateMonthlyChart(yearLessons) {
            const ctx = document.getElementById('monthlyChart').getContext('2d');
            
            // Destroy existing chart
            if (window.monthlyChart) {
                window.monthlyChart.destroy();
            }
            
            const monthlyData = new Array(12).fill(0);
            yearLessons.filter(l => l.status === 2).forEach(lesson => {
                const month = new Date(lesson.date).getMonth();
                monthlyData[month]++;
            });
            
            window.monthlyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                    datasets: [{
                        label: 'Aulas Dadas',
                        data: monthlyData,
                        backgroundColor: 'rgba(147, 51, 234, 0.1)',
                        borderColor: 'rgba(147, 51, 234, 1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'rgba(147, 51, 234, 1)',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function updateRevenueChart(yearLessons) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Destroy existing chart
            if (window.revenueChart) {
                window.revenueChart.destroy();
            }
            
            const monthlyRevenue = new Array(12).fill(0);
            yearLessons.filter(l => l.status === 2).forEach(lesson => {
                const month = new Date(lesson.date).getMonth();
                monthlyRevenue[month] += lesson.price;
            });
            
            window.revenueChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                    datasets: [{
                        label: 'Receita (R$)',
                        data: monthlyRevenue,
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toFixed(0);
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }

        function updateStatusChart(yearLessons) {
            const ctx = document.getElementById('statusChart').getContext('2d');
            
            // Destroy existing chart
            if (window.statusChart) {
                window.statusChart.destroy();
            }
            
            const statusCounts = [0, 0, 0, 0, 0]; // confirmada, reagendada, dada, cancelada, marcada
            yearLessons.forEach(lesson => {
                statusCounts[lesson.status]++;
            });
            
            // Filter out statuses with 0 count for cleaner display
            const filteredLabels = [];
            const filteredData = [];
            const filteredColors = [];
            const colors = [
                'rgba(34, 197, 94, 0.8)',   // confirmada - green
                'rgba(245, 158, 11, 0.8)',  // reagendada - yellow
                'rgba(59, 130, 246, 0.8)',  // dada - blue
                'rgba(239, 68, 68, 0.8)',   // cancelada - red
                'rgba(147, 51, 234, 0.8)'   // marcada - purple
            ];
            
            statusCounts.forEach((count, index) => {
                if (count > 0) {
                    filteredLabels.push(statusLabels[index]);
                    filteredData.push(count);
                    filteredColors.push(colors[index]);
                }
            });
            
            if (filteredData.length === 0) {
                // Show empty state
                ctx.font = '16px Inter';
                ctx.fillStyle = '#9CA3AF';
                ctx.textAlign = 'center';
                ctx.fillText('Nenhuma aula encontrada', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }
            
            window.statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: filteredLabels,
                    datasets: [{
                        data: filteredData,
                        backgroundColor: filteredColors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        // Login form handler - REMOVIDO (sistema permanente)
        // Sistema agora √© permanente - n√£o precisa mais de login

        // Sistema sem login - handler removido

        // Form handlers
        document.getElementById('lessonForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Comprehensive validation
            const dateValue = document.getElementById('lessonDate').value;
            if (!dateValue) {
                showAlert('Por favor, selecione uma data e hora para a aula.', 'error');
                return;
            }
            
            // Permitir aulas em qualquer data (passado, presente ou futuro)
            const selectedDate = new Date(dateValue);
            
            const priceValue = parseFloat(document.getElementById('lessonPrice').value);
            if (isNaN(priceValue) || priceValue < 0) {
                showAlert('Por favor, insira um pre√ßo v√°lido (maior ou igual a zero).', 'error');
                return;
            }
            
            const durationValue = parseInt(document.getElementById('lessonDuration').value);
            if (isNaN(durationValue) || durationValue <= 0) {
                showAlert('Por favor, insira uma dura√ß√£o v√°lida (maior que zero).', 'error');
                return;
            }
            
            const lessonData = {
                id: currentEditingLesson || Date.now().toString(),
                date: new Date(dateValue),
                studentId: document.getElementById('lessonStudent').value || null,
                style: document.getElementById('lessonStyle').value,
                level: document.getElementById('lessonLevel').value,
                type: document.getElementById('lessonType').value,
                model: document.getElementById('lessonModel').value,
                durationMin: durationValue,
                place: document.getElementById('lessonPlace').value.trim(),
                price: priceValue,
                status: parseInt(document.getElementById('lessonStatus').value),
                notes: document.getElementById('lessonNotes').value.trim()
            };
            
            try {
                if (currentEditingLesson) {
                    const index = lessons.findIndex(l => l.id === currentEditingLesson);
                    if (index !== -1) {
                        lessons[index] = lessonData;
                        showAlert('Aula atualizada com sucesso', 'success');
                    }
                } else {
                    lessons.push(lessonData);
                    showAlert('Aula criada com sucesso', 'success');
                }
                
                saveData();
                closeLessonModal();
                updateCalendar();
                updateLessonsList();
                updateReports();
                
                // Auto-refresh students data if lesson status is "Dada" (status 2)
                if (lessonData.status === 2) {
                    updateStudentsList();
                    populateStudentSelect();
                }
            } catch (error) {
                showAlert('Erro ao salvar a aula. Tente novamente.', 'error');
                console.error('Error saving lesson:', error);
            }
        });

        document.getElementById('studentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const name = document.getElementById('studentName').value.trim();
            if (!name) {
                showAlert('Por favor, insira o nome do aluno.', 'error');
                return;
            }
            
            // Check for duplicate names (excluding current editing student)
            const existingStudent = students.find(s => 
                s.name.toLowerCase() === name.toLowerCase() && 
                s.id !== currentEditingStudent
            );
            if (existingStudent) {
                showAlert('J√° existe um aluno com este nome.', 'warning');
                return;
            }
            
            const email = document.getElementById('studentEmail').value.trim();
            if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showAlert('Por favor, insira um email v√°lido.', 'error');
                return;
            }
            
            const totalLessons = parseInt(document.getElementById('studentTotalLessons').value) || 0;
            if (totalLessons < 0) {
                showAlert('O n√∫mero total de aulas n√£o pode ser negativo.', 'error');
                return;
            }
            
            const studentData = {
                id: currentEditingStudent || Date.now().toString(),
                name: name,
                phone: document.getElementById('studentPhone').value.trim(),
                email: email,
                active: document.getElementById('studentActive').value === 'true',
                packageStart: document.getElementById('studentPackageStart').value,
                packageEnd: document.getElementById('studentPackageEnd').value,
                totalLessons: totalLessons,
                notes: document.getElementById('studentNotes').value.trim()
            };
            
            try {
                if (currentEditingStudent) {
                    const index = students.findIndex(s => s.id === currentEditingStudent);
                    if (index !== -1) {
                        students[index] = studentData;
                        showAlert('Aluno atualizado com sucesso', 'success');
                    }
                } else {
                    students.push(studentData);
                    showAlert('Aluno criado com sucesso', 'success');
                }
                
                saveData();
                closeStudentModal();
                updateStudentsList();
                populateStudentSelect();
                populateEvolutionStudentSelect();
                updateReports();
            } catch (error) {
                showAlert('Erro ao salvar o aluno. Tente novamente.', 'error');
                console.error('Error saving student:', error);
            }
        });

        // Evolution form handler
        document.getElementById('evolutionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const date = document.getElementById('evolutionDate').value;
            const studentId = document.getElementById('evolutionStudent').value;
            const content = document.getElementById('evolutionContent').value.trim();
            
            if (!date) {
                showAlert('Por favor, selecione uma data para a aula.', 'error');
                return;
            }
            
            if (!studentId) {
                showAlert('Por favor, selecione um aluno.', 'error');
                return;
            }
            
            if (!content) {
                showAlert('Por favor, descreva o conte√∫do trabalhado na aula.', 'error');
                return;
            }
            
            const evolutionData = {
                id: currentEditingEvolution || Date.now().toString(),
                date: date,
                studentId: studentId,
                style: document.getElementById('evolutionStyle').value.trim(),
                level: document.getElementById('evolutionLevel').value.trim(),
                duration: parseInt(document.getElementById('evolutionDuration').value) || 60,
                content: content,
                progress: document.getElementById('evolutionProgress').value.trim(),
                difficulties: document.getElementById('evolutionDifficulties').value.trim(),
                nextSteps: document.getElementById('evolutionNextSteps').value.trim(),
                rating: document.getElementById('evolutionRating').value,
                mood: document.getElementById('evolutionMood').value,
                notes: document.getElementById('evolutionNotes').value.trim(),
                createdAt: currentEditingEvolution ? 
                    (evolutions.find(e => e.id === currentEditingEvolution)?.createdAt || new Date().toISOString()) : 
                    new Date().toISOString()
            };
            
            try {
                if (currentEditingEvolution) {
                    const index = evolutions.findIndex(e => e.id === currentEditingEvolution);
                    if (index !== -1) {
                        evolutions[index] = evolutionData;
                        showAlert('Anota√ß√£o de evolu√ß√£o atualizada com sucesso', 'success');
                    }
                } else {
                    evolutions.push(evolutionData);
                    showAlert('Anota√ß√£o de evolu√ß√£o criada com sucesso', 'success');
                }
                
                saveData();
                closeEvolutionModal();
                updateEvolutionTimeline();
            } catch (error) {
                showAlert('Erro ao salvar a anota√ß√£o. Tente novamente.', 'error');
                console.error('Error saving evolution:', error);
            }
        });

        // Revenue visibility control
        let revenueVisibility = {
            annual: true,
            monthly: true,
            chart: true
        };

        function toggleRevenueVisibility(type) {
            revenueVisibility[type] = !revenueVisibility[type];
            
            if (type === 'annual') {
                const revenue = document.getElementById('annualRevenue');
                const hidden = document.getElementById('annualRevenueHidden');
                const eye = document.getElementById('annualRevenueEye');
                
                if (revenueVisibility[type]) {
                    revenue.classList.remove('hidden');
                    hidden.classList.add('hidden');
                    eye.className = 'fas fa-eye text-lg';
                } else {
                    revenue.classList.add('hidden');
                    hidden.classList.remove('hidden');
                    eye.className = 'fas fa-eye-slash text-lg';
                }
            } else if (type === 'monthly') {
                const revenue = document.getElementById('monthlyRevenue');
                const hidden = document.getElementById('monthlyRevenueHidden');
                const eye = document.getElementById('monthlyRevenueEye');
                
                if (revenueVisibility[type]) {
                    revenue.classList.remove('hidden');
                    hidden.classList.add('hidden');
                    eye.className = 'fas fa-eye text-lg';
                } else {
                    revenue.classList.add('hidden');
                    hidden.classList.remove('hidden');
                    eye.className = 'fas fa-eye-slash text-lg';
                }
            } else if (type === 'chart') {
                const chart = document.getElementById('revenueChart');
                const hidden = document.getElementById('revenueChartHidden');
                const eye = document.getElementById('chartRevenueEye');
                
                if (revenueVisibility[type]) {
                    chart.classList.remove('hidden');
                    hidden.classList.add('hidden');
                    eye.className = 'fas fa-eye text-lg';
                    // Redraw chart if it exists
                    if (window.revenueChart) {
                        window.revenueChart.update();
                    }
                } else {
                    chart.classList.add('hidden');
                    hidden.classList.remove('hidden');
                    eye.className = 'fas fa-eye-slash text-lg';
                }
            }
            
            // Save visibility preferences
            localStorage.setItem('revenueVisibility', JSON.stringify(revenueVisibility));
        }

        function loadRevenueVisibility() {
            const saved = localStorage.getItem('revenueVisibility');
            if (saved) {
                revenueVisibility = JSON.parse(saved);
                
                // Apply saved visibility states
                if (!revenueVisibility.annual) {
                    toggleRevenueVisibility('annual');
                }
                if (!revenueVisibility.monthly) {
                    toggleRevenueVisibility('monthly');
                }
                if (!revenueVisibility.chart) {
                    toggleRevenueVisibility('chart');
                }
            }
        }

        // Evolution functions
        function populateEvolutionStudentSelect() {
            const selects = [
                document.getElementById('evolutionStudent'),
                document.getElementById('evolutionStudentFilter')
            ];
            
            selects.forEach(select => {
                if (!select) return;
                
                const isFilter = select.id === 'evolutionStudentFilter';
                select.innerHTML = isFilter ? '<option value="">Todos os alunos</option>' : '<option value="">Selecione um aluno</option>';
                
                const activeStudents = students.filter(s => s.active !== false);
                activeStudents.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    select.appendChild(option);
                });
            });
        }

        function openEvolutionModal(evolutionId = null) {
            currentEditingEvolution = evolutionId;
            const modal = document.getElementById('evolutionModal');
            const form = document.getElementById('evolutionForm');
            
            if (evolutionId) {
                const evolution = evolutions.find(e => e.id === evolutionId);
                if (evolution) {
                    document.getElementById('evolutionDate').value = evolution.date;
                    document.getElementById('evolutionStudent').value = evolution.studentId;
                    document.getElementById('evolutionStyle').value = evolution.style || '';
                    document.getElementById('evolutionLevel').value = evolution.level || '';
                    document.getElementById('evolutionDuration').value = evolution.duration || 60;
                    document.getElementById('evolutionContent').value = evolution.content || '';
                    document.getElementById('evolutionProgress').value = evolution.progress || '';
                    document.getElementById('evolutionDifficulties').value = evolution.difficulties || '';
                    document.getElementById('evolutionNextSteps').value = evolution.nextSteps || '';
                    document.getElementById('evolutionRating').value = evolution.rating || '';
                    document.getElementById('evolutionMood').value = evolution.mood || '';
                    document.getElementById('evolutionNotes').value = evolution.notes || '';
                }
            } else {
                form.reset();
                document.getElementById('evolutionDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('evolutionDuration').value = 60;
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeEvolutionModal() {
            document.getElementById('evolutionModal').classList.add('hidden');
            document.getElementById('evolutionModal').classList.remove('flex');
            currentEditingEvolution = null;
        }

        function clearEvolutionForm() {
            document.getElementById('evolutionForm').reset();
            document.getElementById('evolutionDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('evolutionDuration').value = 60;
        }

        function updateEvolutionTimeline() {
            const timeline = document.getElementById('evolutionTimeline');
            const noDataDiv = document.getElementById('noEvolutionData');
            const studentFilter = document.getElementById('evolutionStudentFilter')?.value || '';
            const searchTerm = document.getElementById('evolutionSearch')?.value.toLowerCase() || '';
            
            let filteredEvolutions = evolutions.filter(evolution => {
                const student = students.find(s => s.id === evolution.studentId);
                const matchesStudent = !studentFilter || evolution.studentId === studentFilter;
                const matchesSearch = !searchTerm || 
                    evolution.content.toLowerCase().includes(searchTerm) ||
                    evolution.progress.toLowerCase().includes(searchTerm) ||
                    evolution.difficulties.toLowerCase().includes(searchTerm) ||
                    evolution.nextSteps.toLowerCase().includes(searchTerm) ||
                    evolution.notes.toLowerCase().includes(searchTerm) ||
                    (student && student.name.toLowerCase().includes(searchTerm));
                
                return matchesStudent && matchesSearch;
            });
            
            // Sort by date (newest first)
            filteredEvolutions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredEvolutions.length === 0) {
                timeline.innerHTML = '';
                noDataDiv.classList.remove('hidden');
                return;
            }
            
            noDataDiv.classList.add('hidden');
            
            timeline.innerHTML = filteredEvolutions.map(evolution => {
                const student = students.find(s => s.id === evolution.studentId);
                const date = new Date(evolution.date);
                const ratingStars = evolution.rating ? '‚≠ê'.repeat(parseInt(evolution.rating)) : '';
                const moodEmoji = getMoodEmoji(evolution.mood);
                
                return `
                    <div class="border-l-4 border-purple-500 pl-6 pb-6 relative">
                        <div class="absolute -left-2 top-0 w-4 h-4 bg-purple-500 rounded-full"></div>
                        
                        <div class="bg-gray-50 rounded-lg p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div class="flex items-center space-x-3">
                                    <h4 class="font-bold text-lg text-gray-800">${student ? student.name : 'Aluno n√£o encontrado'}</h4>
                                    <span class="px-2 py-1 text-xs bg-purple-100 text-purple-700 rounded">
                                        ${date.toLocaleDateString('pt-BR')}
                                    </span>
                                    ${evolution.style ? `<span class="px-2 py-1 text-xs bg-blue-100 text-blue-700 rounded">${evolution.style}</span>` : ''}
                                    ${evolution.level ? `<span class="px-2 py-1 text-xs bg-green-100 text-green-700 rounded">${evolution.level}</span>` : ''}
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${ratingStars ? `<span class="text-sm">${ratingStars}</span>` : ''}
                                    ${moodEmoji ? `<span class="text-lg">${moodEmoji}</span>` : ''}
                                    <button onclick="editEvolution('${evolution.id}')" class="text-blue-600 hover:text-blue-800" title="Editar">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteEvolution('${evolution.id}')" class="text-red-600 hover:text-red-800" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            
                            ${evolution.content ? `
                                <div class="mb-3">
                                    <h5 class="font-medium text-gray-700 mb-1">üìö Conte√∫do Trabalhado:</h5>
                                    <p class="text-gray-600 text-sm">${evolution.content}</p>
                                </div>
                            ` : ''}
                            
                            ${evolution.progress ? `
                                <div class="mb-3">
                                    <h5 class="font-medium text-gray-700 mb-1">üìà Evolu√ß√£o do Aluno:</h5>
                                    <p class="text-gray-600 text-sm">${evolution.progress}</p>
                                </div>
                            ` : ''}
                            
                            ${evolution.difficulties ? `
                                <div class="mb-3">
                                    <h5 class="font-medium text-gray-700 mb-1">‚ö†Ô∏è Dificuldades:</h5>
                                    <p class="text-gray-600 text-sm">${evolution.difficulties}</p>
                                </div>
                            ` : ''}
                            
                            ${evolution.nextSteps ? `
                                <div class="mb-3">
                                    <h5 class="font-medium text-gray-700 mb-1">üéØ Pr√≥ximos Passos:</h5>
                                    <p class="text-gray-600 text-sm">${evolution.nextSteps}</p>
                                </div>
                            ` : ''}
                            
                            ${evolution.notes ? `
                                <div class="mb-3">
                                    <h5 class="font-medium text-gray-700 mb-1">üìù Observa√ß√µes:</h5>
                                    <p class="text-gray-600 text-sm">${evolution.notes}</p>
                                </div>
                            ` : ''}
                            
                            <div class="flex items-center justify-between text-xs text-gray-500 mt-3 pt-3 border-t border-gray-200">
                                <span>
                                    <i class="fas fa-clock mr-1"></i>
                                    ${evolution.duration || 60} minutos
                                </span>
                                <span>Anota√ß√£o criada em ${new Date(evolution.createdAt || evolution.date).toLocaleString('pt-BR')}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getMoodEmoji(mood) {
            const moodMap = {
                'motivated': 'üòä',
                'focused': 'üéØ',
                'tired': 'üò¥',
                'frustrated': 'üò§',
                'excited': 'ü§©',
                'nervous': 'üò∞',
                'confident': 'üòé'
            };
            return moodMap[mood] || '';
        }

        function filterEvolutionByStudent() {
            updateEvolutionTimeline();
        }

        function editEvolution(evolutionId) {
            openEvolutionModal(evolutionId);
        }

        function deleteEvolution(evolutionId) {
            const evolution = evolutions.find(e => e.id === evolutionId);
            const student = students.find(s => s.id === evolution?.studentId);
            const evolutionInfo = evolution ? `anota√ß√£o de ${student?.name || 'aluno desconhecido'} do dia ${new Date(evolution.date).toLocaleDateString('pt-BR')}` : 'esta anota√ß√£o';
            
            showConfirm(`Tem certeza que deseja excluir a ${evolutionInfo}?`, () => {
                evolutions = evolutions.filter(e => e.id !== evolutionId);
                saveData();
                updateEvolutionTimeline();
                showAlert('Anota√ß√£o de evolu√ß√£o exclu√≠da com sucesso', 'success');
            });
        }

        // Data persistence
        function saveData() {
            const dataToSave = {
                students: students,
                lessons: lessons,
                evolutions: evolutions,
                lastModified: new Date().toISOString()
            };
            localStorage.setItem('gestaoDeAulas', JSON.stringify(dataToSave));
        }

        // Backup autom√°tico para prote√ß√£o de dados
        function autoBackup() {
            try {
                const data = {
                    students: students,
                    lessons: lessons,
                    evolutions: evolutions,
                    autoBackupDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                // Manter at√© 5 backups autom√°ticos
                const backupKey = `autoBackup_${Date.now()}`;
                localStorage.setItem(backupKey, JSON.stringify(data));
                
                // Limpar backups antigos (manter apenas os 5 mais recentes)
                const allKeys = Object.keys(localStorage);
                const backupKeys = allKeys.filter(key => key.startsWith('autoBackup_')).sort();
                
                if (backupKeys.length > 5) {
                    const keysToRemove = backupKeys.slice(0, backupKeys.length - 5);
                    keysToRemove.forEach(key => localStorage.removeItem(key));
                }
                
                console.log('Backup autom√°tico realizado:', new Date().toLocaleTimeString());
            } catch (error) {
                console.error('Erro no backup autom√°tico:', error);
            }
        }

        function loadData() {
            const data = localStorage.getItem('gestaoDeAulas');
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    students = parsed.students || [];
                    lessons = (parsed.lessons || []).map(lesson => ({
                        ...lesson,
                        date: new Date(lesson.date)
                    }));
                    evolutions = parsed.evolutions || [];
                    
                    // Se carregou dados com sucesso, mostrar informa√ß√£o
                    if (students.length > 0 || lessons.length > 0 || evolutions.length > 0) {
                        console.log(`Dados carregados: ${students.length} alunos, ${lessons.length} aulas, ${evolutions.length} anota√ß√µes`);
                    }
                } catch (error) {
                    console.error('Erro ao carregar dados principais, tentando backup autom√°tico...', error);
                    tryRecoverFromAutoBackup();
                }
            } else {
                // Tentar recuperar de backup autom√°tico se n√£o h√° dados principais
                tryRecoverFromAutoBackup();
            }
        }

        function tryRecoverFromAutoBackup() {
            try {
                const allKeys = Object.keys(localStorage);
                const backupKeys = allKeys.filter(key => key.startsWith('autoBackup_')).sort().reverse();
                
                if (backupKeys.length > 0) {
                    const latestBackupKey = backupKeys[0];
                    const backupData = localStorage.getItem(latestBackupKey);
                    
                    if (backupData) {
                        const parsed = JSON.parse(backupData);
                        students = parsed.students || [];
                        lessons = (parsed.lessons || []).map(lesson => ({
                            ...lesson,
                            date: new Date(lesson.date)
                        }));
                        evolutions = parsed.evolutions || [];
                        
                        // Salvar como dados principais
                        saveData();
                        
                        if (students.length > 0 || lessons.length > 0 || evolutions.length > 0) {
                            showAlert(`üîÑ Dados recuperados do backup autom√°tico! ${students.length} alunos, ${lessons.length} aulas, ${evolutions.length} anota√ß√µes restauradas.`, 'success');
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao tentar recuperar backup autom√°tico:', error);
                // Inicializar arrays vazios se tudo falhar
                students = [];
                lessons = [];
                evolutions = [];
            }
        }

        // Backup functions
        function sendBackupEmail() {
            // Permitir que o usu√°rio digite o email na hora
            const userEmail = prompt('Digite seu email para receber o backup:');
            
            if (!userEmail || !userEmail.includes('@')) {
                showAlert('Email inv√°lido ou cancelado.', 'error');
                return;
            }
            
            try {
                const data = {
                    students: students,
                    lessons: lessons,
                    evolutions: evolutions,
                    exportDate: new Date().toISOString(),
                    version: '1.0',
                    userEmail: userEmail
                };
                
                const backupContent = JSON.stringify(data, null, 2);
                const subject = `Backup Gest√£o de Aulas - ${new Date().toLocaleDateString('pt-BR')}`;
                const body = `Ol√°!

Aqui est√° o backup dos seus dados do sistema Gest√£o de Aulas:

üìä Resumo do Backup:
‚Ä¢ ${students.length} alunos cadastrados
‚Ä¢ ${lessons.length} aulas registradas
‚Ä¢ ${evolutions.length} anota√ß√µes de evolu√ß√£o
‚Ä¢ Data do backup: ${new Date().toLocaleString('pt-BR')}

üîÑ Para usar em outro dispositivo:
1. Copie todo o conte√∫do JSON abaixo
2. Salve em um arquivo .txt ou .json
3. No novo dispositivo, crie uma conta
4. Use "Restaurar Backup" e selecione o arquivo

üì± IMPORTANTE: Cada dispositivo precisa de sua pr√≥pria conta!
O sistema n√£o sincroniza automaticamente entre dispositivos.

Dados do backup:
${backupContent}

---
Sistema Gest√£o de Aulas
Backup gerado em ${new Date().toLocaleString('pt-BR')}`;

                // Create mailto link
                const mailtoLink = `mailto:${userEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                
                // Try to open email client
                const link = document.createElement('a');
                link.href = mailtoLink;
                link.click();
                
                showAlert(`Email de backup preparado! Verifique seu cliente de email. Para usar em outro dispositivo, crie uma nova conta l√° e restaure este backup.`, 'success');
                
            } catch (error) {
                showAlert('Erro ao preparar o backup por email. Tente o backup local.', 'error');
                console.error('Email backup error:', error);
            }
        }

        function exportData() {
            try {
                const data = {
                    students: students,
                    lessons: lessons,
                    evolutions: evolutions,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `gestao-aulas-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showAlert(`Backup baixado com sucesso! ${students.length} alunos, ${lessons.length} aulas e ${evolutions.length} anota√ß√µes de evolu√ß√£o exportados.`, 'success');
            } catch (error) {
                showAlert('Erro ao criar o backup. Tente novamente.', 'error');
                console.error('Export error:', error);
            }
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showAlert('Por favor, selecione um arquivo para importar.', 'error');
                return;
            }
            
            if (!file.name.endsWith('.json')) {
                showAlert('Por favor, selecione um arquivo JSON v√°lido.', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!data.students || !Array.isArray(data.students) || 
                        !data.lessons || !Array.isArray(data.lessons)) {
                        throw new Error('Formato de arquivo inv√°lido');
                    }
                    
                    showConfirm('Isso substituir√° todos os dados atuais. Deseja continuar?', () => {
                        try {
                            students = data.students;
                            lessons = data.lessons.map(lesson => ({
                                ...lesson,
                                date: new Date(lesson.date)
                            }));
                            evolutions = data.evolutions || [];
                            
                            saveData();
                            updateCalendar();
                            updateLessonsList();
                            updateStudentsList();
                            populateStudentSelect();
                            populateEvolutionStudentSelect();
                            updateEvolutionTimeline();
                            updateReports();
                            
                            showAlert(`Dados importados com sucesso! ${students.length} alunos, ${lessons.length} aulas e ${evolutions.length} anota√ß√µes de evolu√ß√£o.`, 'success');
                            fileInput.value = ''; // Clear file input
                        } catch (error) {
                            showAlert('Erro ao processar os dados importados.', 'error');
                            console.error('Processing error:', error);
                        }
                    });
                } catch (error) {
                    showAlert('Erro ao ler o arquivo. Verifique se est√° no formato JSON correto.', 'error');
                    console.error('Import error:', error);
                }
            };
            
            reader.onerror = function() {
                showAlert('Erro ao ler o arquivo selecionado.', 'error');
            };
            
            reader.readAsText(file);
        }
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'973b2496d6c2e012',t:'MTc1NTk1NzY5Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
